<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy-First Invoice OCR | 隐私优先发票识别</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; }
        .loading-spin {
            border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6;
            border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .active-file { border-left: 4px solid #3b82f6; background-color: #f0f7ff; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <nav class="bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 text-white p-2 rounded-lg font-bold text-xl leading-none">OCR</div>
            <h1 class="text-xl font-bold">Privacy-First <span class="text-blue-600">Invoice</span></h1>
        </div>
        <div class="bg-emerald-50 text-emerald-600 px-4 py-1.5 rounded-full text-xs font-bold border border-emerald-100">
            🛡️ 本地处理：所有数据不离开您的浏览器
        </div>
    </nav>

    <main id="app-container" class="max-w-[1500px] mx-auto p-6">
        
        <section id="page-1" class="block py-20 text-center">
            <h2 class="text-4xl font-black text-slate-800 mb-4">中国电子发票本地识别</h2>
            <p class="text-slate-500 mb-12 text-lg">无需上传，隐私优先，支持 PDF 及图片批量导出 Excel</p>
            
            <div id="drop-area" class="w-full max-w-3xl mx-auto h-80 border-4 border-dashed border-slate-200 rounded-[2rem] bg-white flex flex-col items-center justify-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all group">
                <input type="file" id="file-select" multiple accept="image/*,.pdf" class="hidden">
                <div class="w-20 h-20 bg-slate-50 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                    <svg class="w-10 h-10 text-slate-400 group-hover:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                </div>
                <p class="text-xl font-bold text-slate-700">将发票拖拽至此 或 点击选择</p>
                <p class="text-sm text-slate-400 mt-2 font-medium">支持多张 JPG, PNG, PDF 格式</p>
            </div>
        </section>

        <section id="page-2" class="hidden">
            <div class="flex flex-col lg:flex-row gap-8 h-[calc(100vh-180px)]">
                <div class="flex-1 bg-slate-800 rounded-3xl overflow-hidden relative border border-slate-700 shadow-inner flex flex-col">
                    <div class="bg-slate-900/50 px-6 py-3 flex justify-between items-center border-b border-slate-700">
                        <span id="index-label" class="text-slate-400 text-sm font-bold uppercase tracking-wider">File 1 / 1</span>
                        <div class="flex gap-4">
                            <button onclick="navFile(-1)" class="text-white hover:text-blue-400 disabled:opacity-20 transition-colors">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"></path></svg>
                            </button>
                            <button onclick="navFile(1)" class="text-white hover:text-blue-400 disabled:opacity-20 transition-colors">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 p-6 flex items-center justify-center overflow-hidden">
                        <canvas id="canvas-pdf" class="hidden max-w-full max-h-full shadow-2xl"></canvas>
                        <img id="img-viewer" class="max-w-full max-h-full object-contain shadow-2xl" src="" alt="预览">
                    </div>
                    <div id="ocr-spinner" class="absolute inset-0 bg-slate-900/90 backdrop-blur flex flex-col items-center justify-center text-white hidden">
                        <div class="loading-spin mb-6"></div>
                        <p id="ocr-status-msg" class="text-sm font-bold tracking-widest text-blue-400 uppercase">初始化本地引擎...</p>
                    </div>
                </div>

                <div class="w-full lg:w-[480px] flex flex-col gap-6">
                    <div class="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm flex flex-col flex-1 overflow-hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-black italic">数据校对</h3>
                            <button onclick="document.getElementById('file-select').click()" class="text-blue-600 text-sm font-bold hover:underline">新增文件</button>
                        </div>
                        <div id="invoice-fields" class="space-y-5 overflow-y-auto custom-scroll pr-2 flex-1">
                            </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 shadow-sm h-1/3 flex flex-col overflow-hidden">
                        <div class="px-6 py-3 border-b bg-slate-50 flex justify-between items-center">
                            <span class="text-[10px] font-black text-slate-400 tracking-tighter">当前队列</span>
                            <span id="badge-total" class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">0 张</span>
                        </div>
                        <div id="queue-box" class="flex-1 overflow-y-auto custom-scroll">
                            </div>
                        <div class="p-4">
                            <button onclick="showStep(3)" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-blue-600 transition-all shadow-lg shadow-slate-200">
                                完成核对并导出
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-3" class="hidden max-w-3xl mx-auto">
            <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-2xl p-10">
                <h2 class="text-2xl font-black mb-10 flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center text-white italic text-base">i</div>
                    导出配置
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-10 mb-12">
                    <div class="space-y-8">
                        <div>
                            <p class="text-xs font-black text-slate-400 mb-4 tracking-widest uppercase">1. 导出逻辑</p>
                            <div class="space-y-3">
                                <label class="flex items-center p-4 border-2 rounded-2xl cursor-pointer hover:bg-blue-50 has-[:checked]:border-blue-600 has-[:checked]:bg-blue-50 transition-all">
                                    <input type="radio" name="logic" value="merge" checked class="w-5 h-5 text-blue-600">
                                    <span class="ml-4 font-bold text-slate-700">全部合并为一个文件</span>
                                </label>
                                <label class="flex items-center p-4 border-2 rounded-2xl cursor-pointer hover:bg-blue-50 has-[:checked]:border-blue-600 has-[:checked]:bg-blue-50 transition-all">
                                    <input type="radio" name="logic" value="split" class="w-5 h-5 text-blue-600">
                                    <span class="ml-4 font-bold text-slate-700">按税务局地区分卷</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-3xl p-8 border border-slate-100">
                        <p class="text-xs font-black text-slate-400 mb-6 tracking-widest uppercase text-center">2. 执行下载</p>
                        <div class="grid gap-4">
                            <button onclick="startExport('xlsx')" class="bg-emerald-600 hover:bg-emerald-700 text-white p-5 rounded-2xl font-black flex items-center justify-center gap-3 transition-all shadow-lg shadow-emerald-100">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"></path></svg>
                                EXCEL (.XLSX)
                            </button>
                            <button onclick="startExport('csv')" class="bg-slate-800 hover:bg-slate-900 text-white p-5 rounded-2xl font-black transition-all">
                                CSV 纯文本
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center border-t border-slate-100 pt-8">
                    <button onclick="showStep(2)" class="text-slate-500 font-bold hover:text-blue-600 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7 7-7"></path></svg>
                        返回上一步
                    </button>
                    <button onclick="location.reload()" class="text-red-400 text-sm font-bold hover:underline">清空并重新开始</button>
                </div>
            </div>
        </section>
    </main>

    <script>
        /**
         * 状态对象
         */
        const state = {
            queue: [], // { id, file, type, preview, data, status }
            current: 0,
            ocr: null,
            // 关键修改点：修正 PDF.js 引用变量名
            pdf: window.pdfjsLib 
        };

        // 检查库是否成功加载
        if (!state.pdf) {
            console.error("PDF.js 库加载失败，请检查 CDN 连接。");
        } else {
            // 正确配置 Worker
            state.pdf.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        const fieldsCfg = [
    { key: 'id', label: '发票号码', reg: null },
    { key: 'date', label: '开票日期', reg: null },
    { key: 'buyer', label: '购买方名称', reg: null },
    { key: 'seller', label: '销售方名称', reg: null },
    { key: 'sellerTaxId', label: '销售方税号', reg: null },
    { key: 'amount', label: '金额(不含税)', reg: null }, 
    { key: 'tax', label: '税额', reg: null },
    { key: 'total', label: '价税合计', reg: null },
    { key: 'org', label: '税务局', reg: null }
];
        /**
         * 1. OCR 引擎初始化 (GitHub Pages 路径兼容)
         */
      async function getWorker() {
  if (!state.ocr) {
    setOCRMsg('加载 OCR 引擎...');

    const worker = await Tesseract.createWorker({
      langPath: './tessdata',
      gzip: false,
      logger: m => {
        if (m.status === 'recognizing text') {
          setOCRMsg(`识别中：${Math.round(m.progress * 100)}%`);
        }
      }
    });

    // v5 不需要 load()
    await worker.loadLanguage('chi_sim');
    await worker.initialize('chi_sim');

    state.ocr = worker;
  }

  return state.ocr;
}





        /**
         * 2. 文件上传逻辑
         */
        const fileInp = document.getElementById('file-select');
        const dropBox = document.getElementById('drop-area');

        dropBox.onclick = () => fileInp.click();
        fileInp.onchange = (e) => addFiles(e.target.files);
        
        dropBox.ondragover = (e) => { e.preventDefault(); dropBox.classList.add('border-blue-400', 'bg-blue-50'); };
        dropBox.ondragleave = () => dropBox.classList.remove('border-blue-400', 'bg-blue-50');
        dropBox.ondrop = (e) => { e.preventDefault(); addFiles(e.dataTransfer.files); };

        async function addFiles(list) {
            if (!list.length) return;
            for (const f of Array.from(list)) {
                state.queue.push({
                    id: Math.random().toString(36).substr(2, 9),
                    file: f,
                    type: f.type,
                    preview: null,
                    status: 'pending',
                    data: fieldsCfg.reduce((acc, c) => ({ ...acc, [c.key]: '' }), {})
                });
            }
            showStep(2);
            refreshView();
        }

        /**
         * 3. 页面渲染与 PDF 处理
         */
        async function refreshView() {
            const cur = state.queue[state.current];
            const iv = document.getElementById('img-viewer');
            const cv = document.getElementById('canvas-pdf');
            
            document.getElementById('index-label').innerText = `Invoice ${state.current + 1} / ${state.queue.length}`;
            document.getElementById('badge-total').innerText = `${state.queue.length} 张`;
            
            iv.classList.add('hidden');
            cv.classList.add('hidden');

            if (!cur.preview) {
                cur.preview = cur.type === 'application/pdf' ? await pdf2Img(cur.file) : URL.createObjectURL(cur.file);
            }

            if (cur.type === 'application/pdf') {
                const ctx = cv.getContext('2d');
                const i = new Image();
                i.onload = () => { cv.width = i.width; cv.height = i.height; ctx.drawImage(i, 0, 0); cv.classList.remove('hidden'); };
                i.src = cur.preview;
            } else {
                iv.src = cur.preview;
                iv.classList.remove('hidden');
            }

            renderForm(cur);
            renderQueue();

            if (cur.status === 'pending') startOCR(cur);
        }

        async function pdf2Img(f) {
            try {
                const buf = await f.arrayBuffer();
                const pdfDoc = await state.pdf.getDocument(buf).promise;
                const page = await pdfDoc.getPage(1);
                const vp = page.getViewport({ scale: 2.0 });
                const cvs = document.createElement('canvas');
                const ctx = cvs.getContext('2d');
                cvs.height = vp.height; cvs.width = vp.width;
                await page.render({ canvasContext: ctx, viewport: vp }).promise;
                return cvs.toDataURL('image/png');
            } catch (e) {
                console.error("PDF 处理失败", e);
                return "";
            }
        }

        /**
         * 4. OCR 识别逻辑
         */
       async function startOCR(item) {
    const loading = document.getElementById('ocr-spinner');
    loading.classList.remove('hidden');
    
    try {
        const w = await getWorker();
        
        // 1. 获取完整数据
        const { data } = await w.recognize(item.preview);

        // 2. 结构化解析 (v2.0)
        // 在 startOCR 函数内...
const result = parseInvoice(data);

item.data.id          = result.invoiceNum;
item.data.date        = result.invoiceDate;
item.data.buyer       = result.buyerName;
item.data.seller      = result.sellerName;
item.data.sellerTaxId = result.sellerTaxId;
item.data.total       = result.totalAmount;
item.data.amount      = result.amount;      
item.data.tax         = result.taxAmount;
item.data.org         = result.taxBureau;
        // -------------------------------------------------

        // 兜底逻辑：如果坐标定位没找到 ID/Date，再试一次全文正则 (可选)
        if (!item.data.id) {
             const fallback = data.text.match(/(?:号码|No)[:：.]?\s*(\d{8,20})/i);
             if (fallback) item.data.id = fallback[1];
        }

        item.status = 'done';
        renderForm(item);
        renderQueue();

    } catch (e) {
        console.error(e);
        alert('OCR 识别错误');
    } finally {
        loading.classList.add('hidden');
    }
}

        /**
         * 5. UI 更新组件
         */
        function renderForm(item) {
            const box = document.getElementById('invoice-fields');
            box.innerHTML = '';
            fieldsCfg.forEach(c => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">${c.label}</label>
                    <input type="text" value="${item.data[c.key]}" 
                           class="w-full border border-slate-200 p-3 rounded-xl text-sm font-bold focus:ring-4 focus:ring-blue-50 focus:border-blue-500 outline-none transition-all"
                           oninput="updateData('${c.key}', this.value)">
                `;
                box.appendChild(div);
            });
        }

        function renderQueue() {
            const box = document.getElementById('queue-box');
            box.innerHTML = '';
            state.queue.forEach((f, i) => {
                const d = document.createElement('div');
                d.className = `px-6 py-4 cursor-pointer border-b flex items-center justify-between transition-all ${i === state.current ? 'active-file' : 'hover:bg-slate-50'}`;
                d.innerHTML = `
                    <div class="truncate pr-4 flex-1">
                        <p class="text-xs font-black text-slate-700 truncate mb-0.5">${f.file.name}</p>
                        <p class="text-[10px] text-slate-400 font-bold">${f.data.id || (f.status==='done'?'未识别':'识别中...')}</p>
                    </div>
                    ${f.status === 'done' ? '<span class="text-blue-500">●</span>' : '<span class="animate-pulse text-slate-200">●</span>'}
                `;
                d.onclick = () => { state.current = i; refreshView(); };
                box.appendChild(d);
            });
        }

        /**
         * 6. 控制逻辑
         */
        function updateData(k, v) { state.queue[state.current].data[k] = v; }
        function navFile(d) { const n = state.current + d; if (n >= 0 && n < state.queue.length) { state.current = n; refreshView(); } }
        function showStep(n) { 
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden')); 
            document.getElementById(`page-${n}`).classList.remove('hidden'); 
            window.scrollTo(0,0); 
        }
        function setOCRMsg(t) { document.getElementById('ocr-status-msg').innerText = t; }

        /**
 * 导出功能 - 支持中文表头映射
 */
function startExport(ext) {
    const mode = document.querySelector('input[name="logic"]:checked').value;
    const rawData = state.queue.map(f => f.data);

    // 1. 定义转换函数：将英文 Key 转换为中文 Key
    // SheetJS 会直接使用对象的 Key 作为 Excel 的表头
    const toCN = (arr) => arr.map(item => ({
        "发票号码": item.id,
        "开票日期": item.date,
        "购买方名称": item.buyer,
        "销售方名称": item.seller,
        "销售方税号": item.sellerTaxId || "", // 防止为空时报错
        "价税合计": item.total,
        "税额": item.tax,
        "税务局": item.org
    }));

    if (mode === 'merge') {
        // 模式一：合并导出
        // 先转换成中文 Key，再传给 saveXlsx
        saveXlsx(toCN(rawData), '发票汇总', ext);
    } else {
        // 模式二：按税务局分卷
        // 先用原始数据分组（因为要读取 item.org）
        const groups = rawData.reduce((acc, c) => {
            const k = c.org || '未知税务局';
            if (!acc[k]) acc[k] = [];
            acc[k].push(c);
            return acc;
        }, {});
        
        // 循环导出每一组，导出前转换为中文 Key
        Object.keys(groups).forEach(k => {
            saveXlsx(toCN(groups[k]), `发票_${k}`, ext);
        });
    }
}
        function saveXlsx(arr, name, ext) {
            const ws = XLSX.utils.json_to_sheet(arr);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "数据");
            const fname = `${name}_${new Date().getTime()}.${ext}`;
            if (ext === 'xlsx') XLSX.writeFile(wb, fname);
            else XLSX.writeFile(wb, fname, { bookType: 'csv' });
        }
       /**
 * 基于空间坐标的电子发票结构化解析 (v2.0 - 增加右上角 ID/Date 定位)
 * @param {object} ocrData - Tesseract.recognize 返回的 data 对象
 */
/**
 * 智能发票解析引擎 v3.0 (坐标定位 + 业务规则校验)
 * @param {object} ocrData - Tesseract data 对象
 */
/**
 * 优化版发票解析函数 - 基于关键词锚点与业务规则约束
 * 策略：OCR纠错 -> 状态机定位 -> 强规则清洗
 */
/**
 * 高级发票文本解析引擎
 * 基于：关键词锚点 + 行扫描 + 业务规则约束
 * @param {string} text - OCR 识别出的原始文本
 */
/**
 * 高级票据解析函数 - 纯业务规则与文本流扫描版
 * @param {object} ocrData - Tesseract 识别结果对象 (包含 text 和 lines)
 */
你现在是一个资深 OCR 票据解析工程师。

我已有一个基于 Tesseract.js 的中国电子发票识别项目，
OCR 能输出完整文本，但字段提取不准。

请只修改字段提取逻辑，
不要改 OCR 初始化，不要改 UI，不要改项目结构。

---

【当前必须解决的问题】

1）购买方名称和销售方名称经常读不到  
2）三个金额（税额 / 金额 / 价税合计）无法全部正确提取  
3）金额必须从“￥后面”的数字提取  
4）税务局信息始终无法识别

---

【重要现实】

OCR 文本存在：

- 错别字（名你=名称，价锐=价税）
- 空格断裂（名 称）
- 表格干扰（规格型号 单位 数量 单价）
- 行顺序可能错乱

因此：

❌ 不要依赖 bbox 坐标  
❌ 不要依赖固定位置  
✅ 必须用关键词锚点 + 业务规则

---

【强制解析规则】

=== 1. 名称提取（核心） ===

使用区块状态机：

当遇到：
"购买方" → 进入 buyer 区
"销售方" → 进入 seller 区

在该区内：

匹配：
/名.?称/

提取冒号后的内容。

---

销售方名称必须包含：
有限公司 / 公司 / 集团

否则丢弃。

并过滤含：
规格 型号 单位 数量 单价 的行。

---

=== 2. 金额提取（严格按￥） ===

只允许从：

￥ 或 ¥ 后面提取金额

正则：
/[¥￥]\s*(\d+\.\d{2})/g

提取全部金额后：

转成数字 → 排序

最小 = 税额  
中间 = 金额  
最大 = 价税合计

不要使用全文数字匹配。

---

=== 3. 税务局提取（全局匹配） ===

直接全文匹配：

/[\u4e00-\u9fa5]{2,}(税务局|税务分局)/

不依赖位置。

---

=== 4. OCR纠错字典（必须加入） ===

先对全文做替换：

名你 → 名称  
名 称 → 名称  
价锐 → 价税  
税预 → 税额  
￥ → ¥

---

【输出要求】

只返回：

✔ 修改后的 parseInvoice(text) 函数  
✔ 可直接替换  
✔ 不要解释  
✔ 不要伪代码

返回格式：

{
 buyerName,
 sellerName,
 taxAmount,
 amount,
 totalAmount,
 taxBureau
}

    </script>
</body>
</html>



















