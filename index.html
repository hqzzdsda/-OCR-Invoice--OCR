<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy-First Invoice OCR | éšç§ä¼˜å…ˆå‘ç¥¨è¯†åˆ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; }
        .loading-spin {
            border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6;
            border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .active-file { border-left: 4px solid #3b82f6; background-color: #f0f7ff; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <nav class="bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 text-white p-2 rounded-lg font-bold text-xl leading-none">OCR</div>
            <h1 class="text-xl font-bold">Privacy-First <span class="text-blue-600">Invoice</span></h1>
        </div>
        <div class="bg-emerald-50 text-emerald-600 px-4 py-1.5 rounded-full text-xs font-bold border border-emerald-100">
            ğŸ›¡ï¸ æœ¬åœ°å¤„ç†ï¼šæ‰€æœ‰æ•°æ®ä¸ç¦»å¼€æ‚¨çš„æµè§ˆå™¨
        </div>
    </nav>

    <main id="app-container" class="max-w-[1500px] mx-auto p-6">
        
        <section id="page-1" class="block py-20 text-center">
            <h2 class="text-4xl font-black text-slate-800 mb-4">ä¸­å›½ç”µå­å‘ç¥¨æœ¬åœ°è¯†åˆ«</h2>
            <p class="text-slate-500 mb-12 text-lg">æ— éœ€ä¸Šä¼ ï¼Œéšç§ä¼˜å…ˆï¼Œæ”¯æŒ PDF åŠå›¾ç‰‡æ‰¹é‡å¯¼å‡º Excel</p>
            
            <div id="drop-area" class="w-full max-w-3xl mx-auto h-80 border-4 border-dashed border-slate-200 rounded-[2rem] bg-white flex flex-col items-center justify-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all group">
                <input type="file" id="file-select" multiple accept="image/*,.pdf" class="hidden">
                <div class="w-20 h-20 bg-slate-50 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                    <svg class="w-10 h-10 text-slate-400 group-hover:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                </div>
                <p class="text-xl font-bold text-slate-700">å°†å‘ç¥¨æ‹–æ‹½è‡³æ­¤ æˆ– ç‚¹å‡»é€‰æ‹©</p>
                <p class="text-sm text-slate-400 mt-2 font-medium">æ”¯æŒå¤šå¼  JPG, PNG, PDF æ ¼å¼</p>
            </div>
        </section>

        <section id="page-2" class="hidden">
            <div class="flex flex-col lg:flex-row gap-8 h-[calc(100vh-180px)]">
                <div class="flex-1 bg-slate-800 rounded-3xl overflow-hidden relative border border-slate-700 shadow-inner flex flex-col">
                    <div class="bg-slate-900/50 px-6 py-3 flex justify-between items-center border-b border-slate-700">
                        <span id="index-label" class="text-slate-400 text-sm font-bold uppercase tracking-wider">File 1 / 1</span>
                        <div class="flex gap-4">
                            <button onclick="navFile(-1)" class="text-white hover:text-blue-400 disabled:opacity-20 transition-colors">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"></path></svg>
                            </button>
                            <button onclick="navFile(1)" class="text-white hover:text-blue-400 disabled:opacity-20 transition-colors">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 p-6 flex items-center justify-center overflow-hidden">
                        <canvas id="canvas-pdf" class="hidden max-w-full max-h-full shadow-2xl"></canvas>
                        <img id="img-viewer" class="max-w-full max-h-full object-contain shadow-2xl" src="" alt="é¢„è§ˆ">
                    </div>
                    <div id="ocr-spinner" class="absolute inset-0 bg-slate-900/90 backdrop-blur flex flex-col items-center justify-center text-white hidden">
                        <div class="loading-spin mb-6"></div>
                        <p id="ocr-status-msg" class="text-sm font-bold tracking-widest text-blue-400 uppercase">åˆå§‹åŒ–æœ¬åœ°å¼•æ“...</p>
                    </div>
                </div>

                <div class="w-full lg:w-[480px] flex flex-col gap-6">
                    <div class="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm flex flex-col flex-1 overflow-hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-black italic">æ•°æ®æ ¡å¯¹</h3>
                            <button onclick="document.getElementById('file-select').click()" class="text-blue-600 text-sm font-bold hover:underline">æ–°å¢æ–‡ä»¶</button>
                        </div>
                        <div id="invoice-fields" class="space-y-5 overflow-y-auto custom-scroll pr-2 flex-1">
                            </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 shadow-sm h-1/3 flex flex-col overflow-hidden">
                        <div class="px-6 py-3 border-b bg-slate-50 flex justify-between items-center">
                            <span class="text-[10px] font-black text-slate-400 tracking-tighter">å½“å‰é˜Ÿåˆ—</span>
                            <span id="badge-total" class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">0 å¼ </span>
                        </div>
                        <div id="queue-box" class="flex-1 overflow-y-auto custom-scroll">
                            </div>
                        <div class="p-4">
                            <button onclick="showStep(3)" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-blue-600 transition-all shadow-lg shadow-slate-200">
                                å®Œæˆæ ¸å¯¹å¹¶å¯¼å‡º
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-3" class="hidden max-w-3xl mx-auto">
            <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-2xl p-10">
                <h2 class="text-2xl font-black mb-10 flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center text-white italic text-base">i</div>
                    å¯¼å‡ºé…ç½®
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-10 mb-12">
                    <div class="space-y-8">
                        <div>
                            <p class="text-xs font-black text-slate-400 mb-4 tracking-widest uppercase">1. å¯¼å‡ºé€»è¾‘</p>
                            <div class="space-y-3">
                                <label class="flex items-center p-4 border-2 rounded-2xl cursor-pointer hover:bg-blue-50 has-[:checked]:border-blue-600 has-[:checked]:bg-blue-50 transition-all">
                                    <input type="radio" name="logic" value="merge" checked class="w-5 h-5 text-blue-600">
                                    <span class="ml-4 font-bold text-slate-700">å…¨éƒ¨åˆå¹¶ä¸ºä¸€ä¸ªæ–‡ä»¶</span>
                                </label>
                                <label class="flex items-center p-4 border-2 rounded-2xl cursor-pointer hover:bg-blue-50 has-[:checked]:border-blue-600 has-[:checked]:bg-blue-50 transition-all">
                                    <input type="radio" name="logic" value="split" class="w-5 h-5 text-blue-600">
                                    <span class="ml-4 font-bold text-slate-700">æŒ‰ç¨åŠ¡å±€åœ°åŒºåˆ†å·</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-3xl p-8 border border-slate-100">
                        <p class="text-xs font-black text-slate-400 mb-6 tracking-widest uppercase text-center">2. æ‰§è¡Œä¸‹è½½</p>
                        <div class="grid gap-4">
                            <button onclick="startExport('xlsx')" class="bg-emerald-600 hover:bg-emerald-700 text-white p-5 rounded-2xl font-black flex items-center justify-center gap-3 transition-all shadow-lg shadow-emerald-100">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"></path></svg>
                                EXCEL (.XLSX)
                            </button>
                            <button onclick="startExport('csv')" class="bg-slate-800 hover:bg-slate-900 text-white p-5 rounded-2xl font-black transition-all">
                                CSV çº¯æ–‡æœ¬
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center border-t border-slate-100 pt-8">
                    <button onclick="showStep(2)" class="text-slate-500 font-bold hover:text-blue-600 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7 7-7"></path></svg>
                        è¿”å›ä¸Šä¸€æ­¥
                    </button>
                    <button onclick="location.reload()" class="text-red-400 text-sm font-bold hover:underline">æ¸…ç©ºå¹¶é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </section>
    </main>

    <script>
        /**
         * çŠ¶æ€å¯¹è±¡
         */
        const state = {
            queue: [], // { id, file, type, preview, data, status }
            current: 0,
            ocr: null,
            // å…³é”®ä¿®æ”¹ç‚¹ï¼šä¿®æ­£ PDF.js å¼•ç”¨å˜é‡å
            pdf: window.pdfjsLib 
        };

        // æ£€æŸ¥åº“æ˜¯å¦æˆåŠŸåŠ è½½
        if (!state.pdf) {
            console.error("PDF.js åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ CDN è¿æ¥ã€‚");
        } else {
            // æ­£ç¡®é…ç½® Worker
            state.pdf.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        const fieldsCfg = [
            { key: 'id', label: 'å‘ç¥¨å·ç ', reg: /(?:ä»£ç |å·ç )[:ï¼š]?\s*(\d+)/ },
            { key: 'date', label: 'å¼€ç¥¨æ—¥æœŸ', reg: /(\d{4}\s*å¹´\s*\d{1,2}\s*æœˆ\s*\d{1,2}\s*æ—¥)/ },
            { key: 'buyer', label: 'è´­ä¹°æ–¹', reg: /(?:è´­ä¹°æ–¹|åç§°)[:ï¼š]?\s*([\u4e00-\u9fa5ï¼ˆï¼‰]{4,})/ },
            { key: 'seller', label: 'é”€å”®æ–¹', reg: /(?:é”€å”®æ–¹|åç§°)[:ï¼š]?\s*([\u4e00-\u9fa5ï¼ˆï¼‰]{4,})/ },
            { key: 'total', label: 'åˆè®¡é‡‘é¢', reg: /(?:åˆè®¡|å°å†™)[:ï¼š]?\s*[ï¿¥Â¥]?\s*(\d+\.\d{2})/ },
            { key: 'tax', label: 'ç¨é¢', reg: /ç¨\s*é¢[:ï¼š]?\s*[ï¿¥Â¥]?\s*(\d+\.\d{2})/ },
            { key: 'org', label: 'ç¨åŠ¡å±€', reg: /([\u4e00-\u9fa5]{2,}(?:ç¨åŠ¡å±€|ç¨åŠ¡åˆ†å±€))/ }
        ];

        /**
         * 1. OCR å¼•æ“åˆå§‹åŒ– (GitHub Pages è·¯å¾„å…¼å®¹)
         */
        async function getWorker() {
  if (!state.ocr) {
    setOCRMsg('åŠ è½½è¯­è¨€åŒ…...');

    const worker = await Tesseract.createWorker({
      workerPath: 'https://unpkg.com/tesseract.js@5.0.3/dist/worker.min.js',
      corePath: 'https://unpkg.com/tesseract.js-core@5.0.0/tesseract.js-core.wasm.js',
      langPath: 'https://hqzzdsda.github.io/-OCR-Invoice--OCR/tessdata'
    });

    // åŠ è½½ä¸­æ–‡è¯­è¨€
    await worker.loadLanguage('chi_sim');
    await worker.initialize('chi_sim');

    // å‘ç¥¨ä¼˜åŒ–å‚æ•°ï¼ˆé‡è¦ï¼‰
    await worker.setParameters({
      tessedit_pageseg_mode: 6,   // é€‚åˆç¥¨æ®ç‰ˆå¼
      preserve_interword_spaces: '1'
    });

    state.ocr = worker;
  }

  return state.ocr;
}


        /**
         * 2. æ–‡ä»¶ä¸Šä¼ é€»è¾‘
         */
        const fileInp = document.getElementById('file-select');
        const dropBox = document.getElementById('drop-area');

        dropBox.onclick = () => fileInp.click();
        fileInp.onchange = (e) => addFiles(e.target.files);
        
        dropBox.ondragover = (e) => { e.preventDefault(); dropBox.classList.add('border-blue-400', 'bg-blue-50'); };
        dropBox.ondragleave = () => dropBox.classList.remove('border-blue-400', 'bg-blue-50');
        dropBox.ondrop = (e) => { e.preventDefault(); addFiles(e.dataTransfer.files); };

        async function addFiles(list) {
            if (!list.length) return;
            for (const f of Array.from(list)) {
                state.queue.push({
                    id: Math.random().toString(36).substr(2, 9),
                    file: f,
                    type: f.type,
                    preview: null,
                    status: 'pending',
                    data: fieldsCfg.reduce((acc, c) => ({ ...acc, [c.key]: '' }), {})
                });
            }
            showStep(2);
            refreshView();
        }

        /**
         * 3. é¡µé¢æ¸²æŸ“ä¸ PDF å¤„ç†
         */
        async function refreshView() {
            const cur = state.queue[state.current];
            const iv = document.getElementById('img-viewer');
            const cv = document.getElementById('canvas-pdf');
            
            document.getElementById('index-label').innerText = `Invoice ${state.current + 1} / ${state.queue.length}`;
            document.getElementById('badge-total').innerText = `${state.queue.length} å¼ `;
            
            iv.classList.add('hidden');
            cv.classList.add('hidden');

            if (!cur.preview) {
                cur.preview = cur.type === 'application/pdf' ? await pdf2Img(cur.file) : URL.createObjectURL(cur.file);
            }

            if (cur.type === 'application/pdf') {
                const ctx = cv.getContext('2d');
                const i = new Image();
                i.onload = () => { cv.width = i.width; cv.height = i.height; ctx.drawImage(i, 0, 0); cv.classList.remove('hidden'); };
                i.src = cur.preview;
            } else {
                iv.src = cur.preview;
                iv.classList.remove('hidden');
            }

            renderForm(cur);
            renderQueue();

            if (cur.status === 'pending') startOCR(cur);
        }

        async function pdf2Img(f) {
            try {
                const buf = await f.arrayBuffer();
                const pdfDoc = await state.pdf.getDocument(buf).promise;
                const page = await pdfDoc.getPage(1);
                const vp = page.getViewport({ scale: 2.0 });
                const cvs = document.createElement('canvas');
                const ctx = cvs.getContext('2d');
                cvs.height = vp.height; cvs.width = vp.width;
                await page.render({ canvasContext: ctx, viewport: vp }).promise;
                return cvs.toDataURL('image/png');
            } catch (e) {
                console.error("PDF å¤„ç†å¤±è´¥", e);
                return "";
            }
        }

        /**
         * 4. OCR è¯†åˆ«é€»è¾‘
         */
        async function startOCR(item) {
            const loading = document.getElementById('ocr-spinner');
            loading.classList.remove('hidden');
            try {
                const w = await getWorker();
                const { data: { text } } = await w.recognize(item.preview);
                fieldsCfg.forEach(c => {
                    const m = text.match(c.reg);
                    if (m) item.data[c.key] = m[1] || m[0];
                });
                item.status = 'done';
                renderForm(item);
                renderQueue();
            } catch (e) {
                console.error(e);
                alert('OCR è¯†åˆ«å¤±è´¥ï¼Œè¯·ç¡®ä¿ tessdata/ ç›®å½•ä¸‹æœ‰ chi_sim.traineddata æ–‡ä»¶');
            } finally {
                loading.classList.add('hidden');
            }
        }

        /**
         * 5. UI æ›´æ–°ç»„ä»¶
         */
        function renderForm(item) {
            const box = document.getElementById('invoice-fields');
            box.innerHTML = '';
            fieldsCfg.forEach(c => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">${c.label}</label>
                    <input type="text" value="${item.data[c.key]}" 
                           class="w-full border border-slate-200 p-3 rounded-xl text-sm font-bold focus:ring-4 focus:ring-blue-50 focus:border-blue-500 outline-none transition-all"
                           oninput="updateData('${c.key}', this.value)">
                `;
                box.appendChild(div);
            });
        }

        function renderQueue() {
            const box = document.getElementById('queue-box');
            box.innerHTML = '';
            state.queue.forEach((f, i) => {
                const d = document.createElement('div');
                d.className = `px-6 py-4 cursor-pointer border-b flex items-center justify-between transition-all ${i === state.current ? 'active-file' : 'hover:bg-slate-50'}`;
                d.innerHTML = `
                    <div class="truncate pr-4 flex-1">
                        <p class="text-xs font-black text-slate-700 truncate mb-0.5">${f.file.name}</p>
                        <p class="text-[10px] text-slate-400 font-bold">${f.data.id || (f.status==='done'?'æœªè¯†åˆ«':'è¯†åˆ«ä¸­...')}</p>
                    </div>
                    ${f.status === 'done' ? '<span class="text-blue-500">â—</span>' : '<span class="animate-pulse text-slate-200">â—</span>'}
                `;
                d.onclick = () => { state.current = i; refreshView(); };
                box.appendChild(d);
            });
        }

        /**
         * 6. æ§åˆ¶é€»è¾‘
         */
        function updateData(k, v) { state.queue[state.current].data[k] = v; }
        function navFile(d) { const n = state.current + d; if (n >= 0 && n < state.queue.length) { state.current = n; refreshView(); } }
        function showStep(n) { 
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden')); 
            document.getElementById(`page-${n}`).classList.remove('hidden'); 
            window.scrollTo(0,0); 
        }
        function setOCRMsg(t) { document.getElementById('ocr-status-msg').innerText = t; }

        function startExport(ext) {
            const mode = document.querySelector('input[name="logic"]:checked').value;
            const dataArr = state.queue.map(f => f.data);
            
            if (mode === 'merge') {
                saveXlsx(dataArr, 'å‘ç¥¨æ±‡æ€»', ext);
            } else {
                const groups = dataArr.reduce((acc, c) => {
                    const k = c.org || 'æœªçŸ¥ç¨åŠ¡å±€';
                    if (!acc[k]) acc[k] = [];
                    acc[k].push(c);
                    return acc;
                }, {});
                Object.keys(groups).forEach(k => saveXlsx(groups[k], `å‘ç¥¨_${k}`, ext));
            }
        }

        function saveXlsx(arr, name, ext) {
            const ws = XLSX.utils.json_to_sheet(arr);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "æ•°æ®");
            const fname = `${name}_${new Date().getTime()}.${ext}`;
            if (ext === 'xlsx') XLSX.writeFile(wb, fname);
            else XLSX.writeFile(wb, fname, { bookType: 'csv' });
        }
    </script>
</body>
</html>






