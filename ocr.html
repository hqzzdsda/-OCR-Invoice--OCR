<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy-First Invoice OCR - éšç§ä¼˜å…ˆå‘ç¥¨è¯†åˆ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .active-row { background-color: #eff6ff; border-left: 4px solid #3b82f6; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <nav class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 p-2 rounded-lg text-white font-bold text-xl">P</div>
            <h1 class="text-xl font-bold tracking-tight">Privacy-First <span class="text-blue-600">Invoice OCR</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full font-medium border border-green-200">
                ğŸ›¡ï¸ æ‰€æœ‰æ•°æ®ä»…åœ¨æœ¬åœ°å¤„ç†ï¼Œä¸ä¼šä¸Šä¼ æœåŠ¡å™¨
            </span>
        </div>
    </nav>

    <main id="app" class="max-w-[1600px] mx-auto p-6">
        <section id="step1" class="block">
            <div class="flex flex-col items-center justify-center min-h-[70vh] text-center">
                <div class="mb-8">
                    <h2 class="text-4xl font-extrabold mb-4 text-slate-900">è¯†åˆ«ä¸­å›½ç”µå­å‘ç¥¨</h2>
                    <p class="text-slate-500 text-lg">æ”¯æŒå›¾ç‰‡ (JPG/PNG) å’Œ PDF æ ¼å¼æ–‡ä»¶</p>
                </div>
                
                <div id="drop-zone" class="w-full max-w-2xl h-80 border-4 border-dashed border-slate-300 rounded-3xl flex flex-col items-center justify-center bg-white hover:border-blue-400 hover:bg-blue-50 transition-all cursor-pointer group">
                    <input type="file" id="file-input" multiple accept="image/*,.pdf" class="hidden">
                    <div class="bg-slate-100 p-6 rounded-full mb-4 group-hover:scale-110 transition-transform">
                        <svg class="w-12 h-12 text-slate-400 group-hover:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    </div>
                    <p class="text-xl font-medium text-slate-600">ç‚¹å‡»æˆ–å°†æ–‡ä»¶æ‹–æ‹½è‡³æ­¤å¤„</p>
                    <p class="text-sm text-slate-400 mt-2">æ”¯æŒå¤šæ–‡ä»¶æ‰¹é‡ä¸Šä¼ </p>
                </div>
            </div>
        </section>

        <section id="step2" class="hidden">
            <div class="flex gap-6 h-[calc(100vh-160px)]">
                <div class="w-1/2 bg-slate-900 rounded-2xl overflow-hidden relative flex flex-col">
                    <div class="bg-slate-800 px-4 py-2 flex justify-between items-center text-white text-sm">
                        <span id="page-info">æ­£åœ¨åŠ è½½å›¾ç‰‡...</span>
                        <div class="space-x-2">
                            <button onclick="changePage(-1)" class="px-3 py-1 bg-slate-700 rounded hover:bg-slate-600 disabled:opacity-30">ä¸Šä¸€ä¸ª</button>
                            <button onclick="changePage(1)" class="px-3 py-1 bg-slate-700 rounded hover:bg-slate-600 disabled:opacity-30">ä¸‹ä¸€ä¸ª</button>
                        </div>
                    </div>
                    <div class="flex-1 flex items-center justify-center p-4">
                        <canvas id="pdf-canvas" class="hidden shadow-2xl"></canvas>
                        <img id="img-preview" class="max-w-full max-h-full object-contain shadow-2xl" src="" alt="">
                    </div>
                    <div id="ocr-loading-overlay" class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white hidden">
                        <div class="loading-spinner mb-4"></div>
                        <p id="ocr-status-text">æ­£åœ¨åˆå§‹åŒ– OCR å¼•æ“...</p>
                    </div>
                </div>

                <div class="w-1/2 flex flex-col gap-4 overflow-hidden">
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 overflow-y-auto flex-1">
                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 class="text-lg font-bold">è¯†åˆ«ç»“æœæ ¸å¯¹</h3>
                            <button onclick="triggerFileInput()" class="text-blue-600 text-sm font-medium hover:underline">+ æ·»åŠ æ›´å¤š</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4" id="ocr-form">
                            </div>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 h-1/3 overflow-hidden flex flex-col">
                        <h3 class="text-sm font-bold mb-3 text-slate-500 uppercase tracking-wider">å¯¼å‡ºé¢„è§ˆ (å®æ—¶)</h3>
                        <div class="overflow-auto flex-1 border rounded-lg">
                            <table class="min-w-full text-xs text-left">
                                <thead class="bg-slate-50 sticky top-0">
                                    <tr>
                                        <th class="p-2 border-b">å‘ç¥¨å·ç </th>
                                        <th class="p-2 border-b">é”€å”®æ–¹</th>
                                        <th class="p-2 border-b">é‡‘é¢</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-table-body"></tbody>
                            </table>
                        </div>
                        <button onclick="goToStep(3)" class="mt-4 w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">
                            ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©å¯¼å‡ºæ–¹å¼
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="step3" class="hidden">
            <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl border border-slate-200 p-8">
                <h2 class="text-2xl font-bold mb-8 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    å¯¼å‡ºå¯¼å‡ºè®¾ç½®
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-3">1. é€‰æ‹©å¯¼å‡ºé€»è¾‘</label>
                            <div class="space-y-2">
                                <label class="flex items-center p-4 border rounded-xl cursor-pointer hover:bg-blue-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                                    <input type="radio" name="export-logic" value="all" checked class="w-4 h-4 text-blue-600">
                                    <span class="ml-3 font-medium text-slate-700">ä¸åˆ†ç±»ï¼šå…¨éƒ¨åˆå¹¶å¯¼å‡º</span>
                                </label>
                                <label class="flex items-center p-4 border rounded-xl cursor-pointer hover:bg-blue-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                                    <input type="radio" name="export-logic" value="authority" class="w-4 h-4 text-blue-600">
                                    <span class="ml-3 font-medium text-slate-700">æŒ‰ç¨åŠ¡å±€åˆ†ç±»ï¼šæ¯ä¸ªå±€ä¸€ä¸ªæ–‡ä»¶</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-3">2. é‡‘é¢è¿‡æ»¤ (å¯é€‰)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="min-amount" placeholder="æœ€å°é‡‘é¢" class="w-full border p-3 rounded-xl">
                                <span class="text-slate-400">è‡³</span>
                                <input type="number" id="max-amount" placeholder="æœ€å¤§é‡‘é¢" class="w-full border p-3 rounded-xl">
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-2xl p-6 border border-slate-100">
                        <label class="block text-sm font-bold text-slate-700 mb-3 text-center">3. é€‰æ‹©æ–‡ä»¶æ ¼å¼</label>
                        <div class="flex flex-col gap-3">
                            <button onclick="handleExport('xlsx')" class="flex items-center justify-center gap-2 bg-green-600 text-white p-4 rounded-xl font-bold hover:bg-green-700 transition-all">
                                å¯¼å‡ºä¸º Excel (.xlsx)
                            </button>
                            <button onclick="handleExport('csv')" class="flex items-center justify-center gap-2 bg-slate-700 text-white p-4 rounded-xl font-bold hover:bg-slate-600 transition-all">
                                å¯¼å‡ºä¸º CSV (.csv)
                            </button>
                        </div>
                        <p class="text-xs text-slate-400 mt-4 leading-relaxed text-center">
                            æç¤ºï¼šå¦‚æœé€‰æ‹©â€œæŒ‰ç¨åŠ¡å±€åˆ†ç±»â€ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šè§¦å‘å¤šä¸ªæ–‡ä»¶ä¸‹è½½ï¼Œè¯·åœ¨å¼¹å‡ºçª—å£ä¸­å…è®¸ä¸‹è½½ã€‚
                        </p>
                    </div>
                </div>

                <div class="flex justify-between border-t pt-6">
                    <button onclick="goToStep(2)" class="px-6 py-2 text-slate-500 font-medium hover:text-slate-800 underline">è¿”å›æ ¸å¯¹æ•°æ®</button>
                    <button onclick="location.reload()" class="px-6 py-2 text-red-500 font-medium hover:text-red-700">æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶é€€å‡º</button>
                </div>
            </div>
        </section>
    </main>

    <script>
        /**
         * çŠ¶æ€ç®¡ç†
         */
        let state = {
            files: [], // { id, name, type, blob, previewUrl, data, status: 'pending'|'processing'|'done' }
            currentIndex: 0,
            ocrWorker: null,
            pdfJS: window['pdfjs-dist/build/pdf']
        };

        // åˆå§‹åŒ– PDF.js Worker
        state.pdfJS.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const fields = [
            { key: 'invoiceNum', label: 'å‘ç¥¨å·ç ', pattern: /(?:ä»£ç |å·ç )[:ï¼š]?\s*(\d+)/ },
            { key: 'date', label: 'å¼€ç¥¨æ—¥æœŸ', pattern: /(\d{4}\s*å¹´\s*\d{1,2}\s*æœˆ\s*\d{1,2}\s*æ—¥)/ },
            { key: 'buyer', label: 'è´­ä¹°æ–¹åç§°', pattern: /(?:è´­ä¹°æ–¹|åç§°)[:ï¼š]?\s*([\u4e00-\u9fa5ï¼ˆï¼‰]+)/ },
            { key: 'seller', label: 'é”€å”®æ–¹åç§°', pattern: /(?:é”€å”®æ–¹|åç§°)[:ï¼š]?\s*([\u4e00-\u9fa5ï¼ˆï¼‰]+)/ },
            { key: 'sellerTaxId', label: 'çº³ç¨äººè¯†åˆ«å·', pattern: /[A-Z0-9]{15,20}/ },
            { key: 'total', label: 'ä»·ç¨åˆè®¡', pattern: /(?:åˆè®¡|å°å†™)[:ï¼š]?\s*[ï¿¥Â¥]?\s*(\d+\.\d{2})/ },
            { key: 'tax', label: 'ç¨é¢', pattern: /ç¨\s*é¢[:ï¼š]?\s*[ï¿¥Â¥]?\s*(\d+\.\d{2})/ },
            { key: 'taxAuthority', label: 'å…¬ç« ç¨åŠ¡å±€', pattern: /([\u4e00-\u9fa5]+ç¨åŠ¡å±€)/ }
        ];

        /**
 * ä¿®æ”¹åçš„åˆå§‹åŒ– OCR å¼•æ“ (ä½¿ç”¨æœ¬åœ°è¯­è¨€åŒ…)
 */
async function initOCR() {
    if (!state.ocrWorker) {
        showOCRStatus('æ­£åœ¨ä»æœ¬åœ°åŠ è½½è¯­è¨€åŒ…...');
        
        try {
            // è·å–å½“å‰ index.html çš„ç»å¯¹è·¯å¾„ç›®å½•ï¼Œç¡®ä¿ langPath å¼•ç”¨æ­£ç¡®
            const basePath = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
            const localLangPath = basePath + '/tessdata';

            // åˆ›å»º Worker
            // æ³¨æ„ï¼š'chi_sim' å¯¹åº” tessdata/chi_sim.traineddata
            state.ocrWorker = await Tesseract.createWorker('chi_sim', 1, {
                // 1. æŒ‡å®šæœ¬åœ°è¯­è¨€åŒ…ç›®å½•
                langPath: localLangPath,
                
                // 2. å¿…é¡»è®¾ç½®ä¸º falseï¼Œå› ä¸ºä½ æœ¬åœ°çš„æ–‡ä»¶æ˜¯ .traineddata è€Œä¸æ˜¯ .traineddata.gz
                gzip: false,
                
                // 3. æ ¸å¿ƒç»„ä»¶ä»å¯ä½¿ç”¨ CDNï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥ä¸‹è½½åˆ°æœ¬åœ°åä¿®æ”¹è¿™äº›è·¯å¾„
                workerPath: 'https://unpkg.com/tesseract.js@5.0.3/dist/worker.min.js',
                corePath: 'https://unpkg.com/tesseract.js-core@5.0.0/tesseract.js-core.wasm.js',
                
                // æ‰“å°è¿›åº¦
                logger: m => {
                    if (m.status === 'recognizing text') {
                        showOCRStatus(`è¯†åˆ«è¿›åº¦: ${Math.floor(m.progress * 100)}%`);
                    } else {
                        showOCRStatus(`çŠ¶æ€: ${m.status}`);
                    }
                }
            });

            console.log("OCR Worker åˆå§‹åŒ–æˆåŠŸï¼Œä½¿ç”¨æœ¬åœ°è¯­è¨€åŒ…:", localLangPath);
        } catch (err) {
            console.error("OCR åˆå§‹åŒ–å¤±è´¥:", err);
            showOCRStatus('æœ¬åœ°è¯­è¨€åŒ…åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿ tessdata ç›®å½•å­˜åœ¨ä¸”åŒ…å« chi_sim.traineddata');
            throw err;
        }
    }
}


        /**
         * é¡µé¢åˆ‡æ¢é€»è¾‘
         */
        function goToStep(num) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`step${num}`).classList.remove('hidden');
            if (num === 2) {
                renderCurrentFile();
                updatePreviewTable();
            }
        }

        /**
         * æ–‡ä»¶å¤„ç†
         */
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');

        function triggerFileInput() { fileInput.click(); }

        fileInput.onchange = (e) => handleFiles(e.target.files);
        dropZone.onclick = triggerFileInput;
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-50'); };
        dropZone.ondragleave = () => { dropZone.classList.remove('border-blue-500', 'bg-blue-50'); };
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            handleFiles(e.dataTransfer.files);
        };

        async function handleFiles(fileList) {
            const newFiles = Array.from(fileList);
            for (const file of newFiles) {
                const fileObj = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    type: file.type,
                    blob: file,
                    previewUrl: null,
                    status: 'pending',
                    data: fields.reduce((acc, curr) => ({ ...acc, [curr.key]: '' }), {})
                };
                state.files.push(fileObj);
            }
            goToStep(2);
        }

        /**
         * æ¸²æŸ“å½“å‰æ–‡ä»¶ï¼ˆPDF æˆ– å›¾ç‰‡ï¼‰
         */
        async function renderCurrentFile() {
            const file = state.files[state.currentIndex];
            const imgEl = document.getElementById('img-preview');
            const canvas = document.getElementById('pdf-canvas');
            
            document.getElementById('page-info').innerText = `å‘ç¥¨é¢„è§ˆï¼š${state.currentIndex + 1} / ${state.files.length}`;
            
            if (file.type === 'application/pdf') {
                imgEl.classList.add('hidden');
                canvas.classList.remove('hidden');
                await renderPDF(file);
            } else {
                canvas.classList.add('hidden');
                imgEl.classList.remove('hidden');
                if (!file.previewUrl) file.previewUrl = URL.createObjectURL(file.blob);
                imgEl.src = file.previewUrl;
            }

            renderForm();
            
            // å¦‚æœæ²¡è¯†åˆ«è¿‡ï¼Œè‡ªåŠ¨è§¦å‘ OCR
            if (file.status === 'pending') {
                processOCR(file);
            }
        }

        async function renderPDF(file) {
            const arrayBuffer = await file.blob.arrayBuffer();
            const pdf = await state.pdfJS.getDocument(arrayBuffer).promise;
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({ scale: 2.0 });
            const canvas = document.getElementById('pdf-canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            file.previewUrl = canvas.toDataURL('image/png');
        }

       /**
 * ä¿®æ”¹åçš„ OCR è°ƒç”¨é€»è¾‘
 */
async function processOCR(file) {
    const overlay = document.getElementById('ocr-loading-overlay');
    overlay.classList.remove('hidden');
    
    try {
        // 1. åˆå§‹åŒ–ï¼ˆæœ¬åœ°åŠ è½½ï¼‰
        await initOCR();
        
        // 2. æ‰§è¡Œè¯†åˆ«
        // å¯¹äº PDF è½¬å‡ºçš„ DataURL æˆ–ç›´æ¥çš„ Image Blob å‡æœ‰æ•ˆ
        const { data: { text } } = await state.ocrWorker.recognize(file.previewUrl);
        
        console.log("è¯†åˆ«å…¨æ–‡æœ¬ç»“æœ:", text);

        // 3. æ­£åˆ™æå–
        fields.forEach(f => {
            const match = text.match(f.pattern);
            if (match) {
                // ä¼˜å…ˆå–æ•è·ç»„ [1]ï¼Œå¦‚æœæ²¡æœ‰æ•è·ç»„åˆ™å–åŒ¹é…å…¨æ–‡ [0]
                file.data[f.key] = match[1] ? match[1].trim() : match[0].trim();
            }
        });
        
        file.status = 'done';
        renderForm();
        updatePreviewTable();
    } catch (err) {
        console.error("å¤„ç†å¤±è´¥:", err);
        alert('è¯†åˆ«è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æˆ–ç¡®ä¿æœ¬åœ°è¯­è¨€åŒ…è·¯å¾„æ­£ç¡®ã€‚');
    } finally {
        overlay.classList.add('hidden');
    }
}

        function showOCRStatus(text) {
            document.getElementById('ocr-status-text').innerText = text;
        }

        /**
         * UI è¡¨å•æ¸²æŸ“
         */
        function renderForm() {
            const container = document.getElementById('ocr-form');
            const file = state.files[state.currentIndex];
            container.innerHTML = '';

            fields.forEach(f => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-xs font-bold text-slate-400 mb-1">${f.label}</label>
                    <input type="text" value="${file.data[f.key]}" 
                        class="w-full border border-slate-200 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        oninput="updateData('${f.key}', this.value)">
                `;
                container.appendChild(div);
            });
        }

        function updateData(key, value) {
            state.files[state.currentIndex].data[key] = value;
            updatePreviewTable();
        }

        function updatePreviewTable() {
            const tbody = document.getElementById('preview-table-body');
            tbody.innerHTML = '';
            state.files.forEach((f, idx) => {
                const tr = document.createElement('tr');
                if (idx === state.currentIndex) tr.className = 'active-row';
                tr.innerHTML = `
                    <td class="p-2 border-b font-mono">${f.data.invoiceNum || '-'}</td>
                    <td class="p-2 border-b truncate max-w-[100px]">${f.data.seller || '-'}</td>
                    <td class="p-2 border-b text-blue-600 font-bold">ï¿¥${f.data.total || '0.00'}</td>
                `;
                tr.onclick = () => { state.currentIndex = idx; renderCurrentFile(); };
                tbody.appendChild(tr);
            });
        }

        function changePage(dir) {
            const newIdx = state.currentIndex + dir;
            if (newIdx >= 0 && newIdx < state.files.length) {
                state.currentIndex = newIdx;
                renderCurrentFile();
            }
        }

        /**
         * å¯¼å‡ºåŠŸèƒ½å®ç°
         */
        function handleExport(format) {
            const logic = document.querySelector('input[name="export-logic"]:checked').value;
            const min = parseFloat(document.getElementById('min-amount').value) || 0;
            const max = parseFloat(document.getElementById('max-amount').value) || 99999999;

            // è¿‡æ»¤æ•°æ®
            let list = state.files.map(f => f.data).filter(item => {
                const val = parseFloat(item.total) || 0;
                return val >= min && val <= max;
            });

            if (list.length === 0) return alert('æ²¡æœ‰ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„æ•°æ®');

            if (logic === 'all') {
                saveFile(list, 'å‘ç¥¨æ±‡æ€»å¯¼å‡º', format);
            } else {
                // æŒ‰ç¨åŠ¡å±€åˆ†ç»„
                const groups = list.reduce((acc, curr) => {
                    const key = curr.taxAuthority || 'æœªçŸ¥ç¨åŠ¡å±€';
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(curr);
                    return acc;
                }, {});

                Object.keys(groups).forEach(key => {
                    saveFile(groups[key], `å‘ç¥¨_${key}`, format);
                });
            }
        }

        function saveFile(data, fileName, format) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "æ•°æ®");
            
            if (format === 'xlsx') {
                XLSX.writeFile(wb, `${fileName}.xlsx`);
            } else {
                XLSX.writeFile(wb, `${fileName}.csv`, { bookType: 'csv' });
            }
        }
    </script>
</body>
</html>