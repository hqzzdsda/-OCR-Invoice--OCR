<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy-First Invoice OCR | éšç§ä¼˜å…ˆå‘ç¥¨è¯†åˆ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', -apple-system, sans-serif; }
        .loading-ring {
            border: 3px solid #f3f3f3; border-top: 3px solid #2563eb;
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .invoice-card-active { border-left: 4px solid #2563eb; background: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-50 text-slate-900">

    <nav class="bg-white/80 backdrop-blur-md border-b sticky top-0 z-50 px-6 py-3 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">å°</div>
            <span class="font-bold text-lg tracking-tight">Privacy OCR</span>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-[12px] bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full border border-emerald-100 font-medium">
                ğŸ›¡ï¸ éšç§ä¿æŠ¤ï¼šæ‰€æœ‰å¤„ç†å‡åœ¨æœ¬åœ°æµè§ˆå™¨å®Œæˆï¼Œæ•°æ®æ°¸ä¸ä¸Šä¼ 
            </span>
        </div>
    </nav>

    <main class="max-w-[1400px] mx-auto p-4 md:p-8">
        
        <section id="step1" class="block">
            <div class="flex flex-col items-center justify-center py-20">
                <div class="text-center mb-10">
                    <h1 class="text-4xl font-extrabold text-slate-900 mb-4">ä¸­å›½ç”µå­å‘ç¥¨è¯†åˆ«</h1>
                    <p class="text-slate-500">æ”¯æŒæ‰¹é‡å¤„ç†å›¾ç‰‡ä¸ PDFï¼Œç»“æ„åŒ–å¯¼å‡º Excel</p>
                </div>

                <div id="drop-zone" class="w-full max-w-3xl h-72 border-2 border-dashed border-slate-300 rounded-3xl bg-white hover:border-blue-500 hover:bg-blue-50/50 transition-all cursor-pointer flex flex-col items-center justify-center group">
                    <input type="file" id="file-input" multiple accept="image/*,.pdf" class="hidden">
                    <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <svg class="w-8 h-8 text-slate-400 group-hover:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    </div>
                    <p class="text-lg font-semibold text-slate-700">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                    <p class="text-sm text-slate-400 mt-1">æ”¯æŒå•å¼ æ¨¡å¼ä¸æ‰¹é‡æ¨¡å¼ (JPG, PNG, PDF)</p>
                </div>
            </div>
        </section>

        <section id="step2" class="hidden">
            <div class="flex flex-col lg:flex-row gap-6 h-[calc(100vh-180px)]">
                
                <div class="flex-1 bg-slate-900 rounded-2xl overflow-hidden relative flex flex-col border border-slate-800">
                    <div class="bg-slate-800/50 px-4 py-3 flex justify-between items-center">
                        <span id="page-indicator" class="text-slate-300 text-sm font-medium">1 / 1</span>
                        <div class="flex gap-2">
                            <button onclick="changePage(-1)" class="p-1.5 hover:bg-slate-700 rounded-md text-slate-300 disabled:opacity-20" id="btn-prev">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <button onclick="changePage(1)" class="p-1.5 hover:bg-slate-700 rounded-md text-slate-300 disabled:opacity-20" id="btn-next">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 flex items-center justify-center p-6 overflow-hidden">
                        <canvas id="pdf-render-canvas" class="hidden shadow-2xl max-w-full max-h-full"></svg>
                        <img id="image-viewer" class="max-w-full max-h-full object-contain shadow-2xl" src="" alt="">
                    </div>

                    <div id="ocr-overlay" class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center text-white hidden">
                        <div class="loading-ring mb-4"></div>
                        <p id="ocr-progress-text" class="text-sm font-medium tracking-wide">æ­£åœ¨åˆå§‹åŒ–æœ¬åœ° OCR å¼•æ“...</p>
                    </div>
                </div>

                <div class="w-full lg:w-[450px] flex flex-col gap-4">
                    <div class="bg-white rounded-2xl p-6 border shadow-sm flex flex-col overflow-hidden h-2/3">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-slate-800">æ•°æ®æ ¡å¯¹</h3>
                            <button onclick="document.getElementById('file-input').click()" class="text-blue-600 text-sm font-semibold">+ æ·»åŠ æ–‡ä»¶</button>
                        </div>
                        <div id="data-form" class="space-y-4 overflow-y-auto custom-scrollbar pr-2 flex-1">
                            </div>
                    </div>

                    <div class="bg-white rounded-2xl border shadow-sm flex flex-col overflow-hidden h-1/3">
                        <div class="px-4 py-3 border-b bg-slate-50 flex justify-between items-center">
                            <span class="text-xs font-bold text-slate-500 uppercase">å½“å‰é˜Ÿåˆ—</span>
                            <span id="queue-count" class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">0 å¼ </span>
                        </div>
                        <div class="flex-1 overflow-y-auto custom-scrollbar" id="file-queue-list">
                            </div>
                        <div class="p-3 bg-white border-t">
                            <button onclick="switchStep(3)" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition-all shadow-lg shadow-blue-100">
                                å¯¼å‡ºç»“æœ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="step3" class="hidden">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-3xl border shadow-xl p-8">
                    <h2 class="text-2xl font-bold text-slate-900 mb-8 flex items-center gap-3">
                        <span class="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center italic">i</span>
                        å¯¼å‡ºé…ç½®ç®¡ç†
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <div class="space-y-8">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-4">å¯¼å‡ºé€»è¾‘</label>
                                <div class="grid gap-3">
                                    <label class="flex items-center p-4 border rounded-2xl cursor-pointer hover:bg-blue-50 transition-all has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                                        <input type="radio" name="export-logic" value="merge" checked class="w-4 h-4 text-blue-600">
                                        <div class="ml-4">
                                            <p class="font-bold text-slate-800">å…¨éƒ¨åˆå¹¶å¯¼å‡º</p>
                                            <p class="text-xs text-slate-400 italic">ç”Ÿæˆä¸€ä¸ªå•ä¸€çš„ Excel æ–‡ä»¶</p>
                                        </div>
                                    </label>
                                    <label class="flex items-center p-4 border rounded-2xl cursor-pointer hover:bg-blue-50 transition-all has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                                        <input type="radio" name="export-logic" value="tax" class="w-4 h-4 text-blue-600">
                                        <div class="ml-4">
                                            <p class="font-bold text-slate-800">æŒ‰ç¨åŠ¡å±€åˆ†ç±»</p>
                                            <p class="text-xs text-slate-400 italic">ä¸åŒåœ°åŒºçš„ç¨åŠ¡å±€ç”Ÿæˆç‹¬ç«‹æ–‡ä»¶</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-4">é‡‘é¢èŒƒå›´è¿‡æ»¤</label>
                                <div class="flex items-center gap-3">
                                    <input type="number" id="filter-min" placeholder="ï¿¥ 0.00" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                                    <span class="text-slate-300">è‡³</span>
                                    <input type="number" id="filter-max" placeholder="ä¸é™" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-50 rounded-3xl p-8 border border-slate-100 flex flex-col justify-center text-center">
                            <h3 class="font-bold text-slate-800 mb-6">ä¸‹è½½æ ¼å¼é€‰æ‹©</h3>
                            <div class="grid gap-4">
                                <button onclick="handleExportAction('xlsx')" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-emerald-100 transition-all">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6m4 18H6V4h7v5h5v11m-10-2h8v-2h-8v2m0-4h8v-2h-8v2m0-4h5v-2h-5v2z"/></svg>
                                    å¯¼å‡º Excel (.xlsx)
                                </button>
                                <button onclick="handleExportAction('csv')" class="w-full bg-slate-800 hover:bg-slate-900 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all">
                                    å¯¼å‡º CSV (.csv)
                                </button>
                            </div>
                            <p class="text-[11px] text-slate-400 mt-6 leading-relaxed">
                                æ³¨æ„ï¼šæ‰¹é‡å¯¼å‡ºå¤šä¸ªæ–‡ä»¶æ—¶ï¼Œè¯·ç¡®ä¿æµè§ˆå™¨å…è®¸å¼¹å‡ºçª—å£ã€‚æ‰€æœ‰æ“ä½œå‡åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å†…å­˜ä¸­å®Œæˆï¼Œå®‰å…¨å¯é ã€‚
                            </p>
                        </div>
                    </div>

                    <div class="mt-10 pt-8 border-t flex justify-between items-center">
                        <button onclick="switchStep(2)" class="text-slate-500 hover:text-blue-600 font-semibold flex items-center gap-2 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7 7-7"></path></svg>
                            è¿”å›æ•°æ®æ ¸å¯¹
                        </button>
                        <button onclick="location.reload()" class="text-red-400 hover:text-red-600 text-sm font-medium">æ¸…ç©ºæ•°æ®å¹¶é€€å‡º</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        /**
         * å…¨å±€çŠ¶æ€ä¸é…ç½®
         */
        let state = {
            files: [], // { id, file, type, preview, data, status: 'pending'|'done' }
            currentIndex: 0,
            worker: null,
            pdfLib: window['pdfjs-dist/build/pdf']
        };

        state.pdfLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const configFields = [
            { key: 'invoiceNum', label: 'å‘ç¥¨å·ç ', reg: /(?:ä»£ç |å·ç )[:ï¼š]?\s*(\d+)/ },
            { key: 'date', label: 'å¼€ç¥¨æ—¥æœŸ', reg: /(\d{4}\s*å¹´\s*\d{1,2}\s*æœˆ\s*\d{1,2}\s*æ—¥)/ },
            { key: 'buyer', label: 'è´­ä¹°æ–¹åç§°', reg: /(?:è´­ä¹°æ–¹|åç§°)[:ï¼š]?\s*([\u4e00-\u9fa5ï¼ˆï¼‰]{4,})/ },
            { key: 'seller', label: 'é”€å”®æ–¹åç§°', reg: /(?:é”€å”®æ–¹|åç§°)[:ï¼š]?\s*([\u4e00-\u9fa5ï¼ˆï¼‰]{4,})/ },
            { key: 'taxId', label: 'é”€å”®æ–¹è¯†åˆ«å·', reg: /[A-Z0-9]{15,20}/ },
            { key: 'total', label: 'ä»·ç¨åˆè®¡', reg: /(?:åˆè®¡|å°å†™)[:ï¼š]?\s*[ï¿¥Â¥]?\s*(\d+\.\d{2})/ },
            { key: 'tax', label: 'ç¨é¢', reg: /ç¨\s*é¢[:ï¼š]?\s*[ï¿¥Â¥]?\s*(\d+\.\d{2})/ },
            { key: 'authority', label: 'å…¬ç« ç¨åŠ¡å±€', reg: /([\u4e00-\u9fa5]{2,}(?:ç¨åŠ¡å±€|ç¨åŠ¡åˆ†å±€))/ }
        ];

        /**
         * 1. OCR å¼•æ“åˆå§‹åŒ– (æ ¸å¿ƒï¼šè·¯å¾„é€‚é… GitHub Pages)
         */
        async function getOCRWorker() {
            if (!state.worker) {
                updateOCRStatus('æ­£åœ¨åˆå§‹åŒ–æœ¬åœ°è¯­è¨€åŒ…...');
                
                // åŠ¨æ€è®¡ç®—ç›¸å¯¹è·¯å¾„ï¼šå…¼å®¹ GitHub Pages å­è·¯å¾„
                // è‹¥åœ°å€ä¸º /repo/index.htmlï¼Œåˆ™è·¯å¾„ä¸º /repo/tessdata
                const basePath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                const localLangPath = window.location.origin + basePath + '/tessdata';

                state.worker = await Tesseract.createWorker('chi_sim', 1, {
                    langPath: localLangPath,
                    gzip: false, // .traineddata åŸå§‹æ–‡ä»¶
                    workerPath: 'https://unpkg.com/tesseract.js@5.0.3/dist/worker.min.js',
                    corePath: 'https://unpkg.com/tesseract.js-core@5.0.0/tesseract.js-core.wasm.js',
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            updateOCRStatus(`æ–‡æœ¬è¯†åˆ«ä¸­: ${Math.floor(m.progress * 100)}%`);
                        }
                    }
                });
            }
            return state.worker;
        }

        /**
         * 2. æ–‡ä»¶ä¸Šä¼ å¤„ç†
         */
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleIncomingFiles(e.target.files);

        // æ‹–æ‹½
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-50'); };
        dropZone.ondragleave = () => { dropZone.classList.remove('border-blue-500', 'bg-blue-50'); };
        dropZone.ondrop = (e) => { e.preventDefault(); handleIncomingFiles(e.dataTransfer.files); };

        async function handleIncomingFiles(fileList) {
            if (!fileList.length) return;
            
            for (const file of Array.from(fileList)) {
                const item = {
                    id: Date.now() + Math.random(),
                    file: file,
                    type: file.type,
                    preview: null,
                    status: 'pending',
                    data: configFields.reduce((acc, f) => ({ ...acc, [f.key]: '' }), {})
                };
                state.files.push(item);
            }
            switchStep(2);
            renderCurrentFile();
            updateQueueList();
        }

        /**
         * 3. é¡µé¢æ¸²æŸ“é€»è¾‘
         */
        async function renderCurrentFile() {
            const current = state.files[state.currentIndex];
            const imgView = document.getElementById('image-viewer');
            const canvasView = document.getElementById('pdf-render-canvas');
            
            // UI æ›´æ–°
            document.getElementById('page-indicator').innerText = `${state.currentIndex + 1} / ${state.files.length}`;
            document.getElementById('queue-count').innerText = `${state.files.length} å¼ `;
            
            // é‡ç½®è§†å›¾
            imgView.classList.add('hidden');
            canvasView.classList.add('hidden');

            // è½¬æ¢æ–‡ä»¶ä¸ºè¯†åˆ«ç”¨å›¾ç‰‡
            if (!current.preview) {
                if (current.type === 'application/pdf') {
                    current.preview = await pdfToImage(current.file);
                } else {
                    current.preview = URL.createObjectURL(current.file);
                }
            }

            // æ˜¾ç¤ºé¢„è§ˆ
            if (current.type === 'application/pdf') {
                const ctx = canvasView.getContext('2d');
                const img = new Image();
                img.onload = () => {
                    canvasView.width = img.width;
                    canvasView.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    canvasView.classList.remove('hidden');
                };
                img.src = current.preview;
            } else {
                imgView.src = current.preview;
                imgView.classList.remove('hidden');
            }

            renderDataForm(current);
            updateQueueList();

            // å¦‚æœæ²¡è¯†åˆ«è¿‡åˆ™å¯åŠ¨ OCR
            if (current.status === 'pending') {
                runOCRTask(current);
            }
        }

        async function pdfToImage(file) {
            const data = await file.arrayBuffer();
            const pdf = await state.pdfLib.getDocument(data).promise;
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({ scale: 2.0 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            return canvas.toDataURL('image/png');
        }

        /**
         * 4. OCR è¯†åˆ«ä»»åŠ¡
         */
        async function runOCRTask(item) {
            const overlay = document.getElementById('ocr-overlay');
            overlay.classList.remove('hidden');

            try {
                const worker = await getOCRWorker();
                const { data: { text } } = await worker.recognize(item.preview);
                
                // æ­£åˆ™è§£æ
                configFields.forEach(f => {
                    const match = text.match(f.reg);
                    if (match) item.data[f.key] = match[1] || match[0];
                });

                item.status = 'done';
                renderDataForm(item);
                updateQueueList();
            } catch (err) {
                console.error(err);
                alert('è¯†åˆ«å‡ºé”™ï¼Œè¯·æ£€æŸ¥æœ¬åœ°èµ„æºè·¯å¾„');
            } finally {
                overlay.classList.add('hidden');
            }
        }

        /**
         * 5. UI äº¤äº’ç»„ä»¶
         */
        function renderDataForm(item) {
            const container = document.getElementById('data-form');
            container.innerHTML = '';
            configFields.forEach(f => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">${f.label}</label>
                    <input type="text" value="${item.data[f.key]}" 
                           class="w-full border border-slate-200 p-2.5 rounded-xl text-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-50 outline-none transition-all"
                           oninput="updateItemData('${f.key}', this.value)">
                `;
                container.appendChild(div);
            });
        }

        function updateItemData(key, val) {
            state.files[state.currentIndex].data[key] = val;
        }

        function updateQueueList() {
            const list = document.getElementById('file-queue-list');
            list.innerHTML = '';
            state.files.forEach((f, i) => {
                const div = document.createElement('div');
                div.className = `px-4 py-3 cursor-pointer border-b text-sm flex items-center justify-between transition-colors ${i === state.currentIndex ? 'invoice-card-active' : 'hover:bg-slate-50'}`;
                div.innerHTML = `
                    <div class="truncate pr-4">
                        <p class="font-medium text-slate-700 truncate">${f.file.name}</p>
                        <p class="text-[10px] text-slate-400 font-mono italic">${f.data.invoiceNum || (f.status === 'done' ? 'æœªè¯†åˆ«åˆ°å·ç ' : 'ç­‰å¾…è¯†åˆ«...')}</p>
                    </div>
                    ${f.status === 'done' ? 'âœ…' : '<span class="animate-pulse">â³</span>'}
                `;
                div.onclick = () => { state.currentIndex = i; renderCurrentFile(); };
                list.appendChild(div);
            });
        }

        function changePage(dir) {
            const target = state.currentIndex + dir;
            if (target >= 0 && target < state.files.length) {
                state.currentIndex = target;
                renderCurrentFile();
            }
        }

        function switchStep(num) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`step${num}`).classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function updateOCRStatus(txt) {
            document.getElementById('ocr-progress-text').innerText = txt;
        }

        /**
         * 6. å¯¼å‡ºé€»è¾‘
         */
        function handleExportAction(ext) {
            const logic = document.querySelector('input[name="export-logic"]:checked').value;
            const min = parseFloat(document.getElementById('filter-min').value) || 0;
            const max = parseFloat(document.getElementById('filter-max').value) || Infinity;

            // è¿‡æ»¤
            let results = state.files.map(f => f.data).filter(d => {
                const amt = parseFloat(d.total) || 0;
                return amt >= min && amt <= max;
            });

            if (results.length === 0) return alert('æ²¡æœ‰ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„å‘ç¥¨æ•°æ®');

            if (logic === 'merge') {
                triggerDownload(results, 'æ‰€æœ‰å‘ç¥¨æ±‡æ€»', ext);
            } else {
                // æŒ‰ç¨åŠ¡å±€åˆ†ç»„
                const groups = results.reduce((acc, curr) => {
                    const key = curr.authority || 'æœªçŸ¥ç¨åŠ¡å±€';
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(curr);
                    return acc;
                }, {});

                Object.keys(groups).forEach(key => {
                    triggerDownload(groups[key], `å‘ç¥¨åˆ†ç±»_${key}`, ext);
                });
            }
        }

        function triggerDownload(data, name, ext) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "OCRæ•°æ®");
            const filename = `${name}_${new Date().toLocaleDateString().replace(/\//g, '-')}.${ext}`;
            
            if (ext === 'xlsx') {
                XLSX.writeFile(wb, filename);
            } else {
                XLSX.writeFile(wb, filename, { bookType: 'csv' });
            }
        }
    </script>
</body>
</html>
